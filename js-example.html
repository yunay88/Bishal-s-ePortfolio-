<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JavaScript Example</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="sticky-top">
      <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand" href="index.html">Back to ePortfolio</a>
        </div>
      </nav>
    </header>
    <main class="container my-5 animate-fade-in">
      <h1>JavaScript Example</h1>
      <p>To-Do app with categories, persistence, and accessibility.</p>
      <div class="card p-4 mb-4 shadow">
        <h2>To-Do App</h2>
        <form id="taskForm" aria-label="Add task">
          <div class="mb-3">
            <label for="task" class="form-label">Task</label>
            <input
              type="text"
              class="form-control"
              id="task"
              required
              aria-describedby="taskError"
            />
            <div id="taskError" class="invalid-feedback">Task is required.</div>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <select
              class="form-select"
              id="category"
              required
              aria-describedby="categoryError"
            >
              <option value="">Select</option>
              <option value="Work">Work</option>
              <option value="Personal">Personal</option>
              <option value="Shopping">Shopping</option>
            </select>
            <div id="categoryError" class="invalid-feedback">
              Category is required.
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Add Task</button>
        </form>
        <div class="mt-3">
          <label for="filterCategory" class="form-label"
            >Filter by Category</label
          >
          <select
            class="form-select"
            id="filterCategory"
            aria-label="Filter tasks by category"
          >
            <option value="">All</option>
            <option value="Work">Work</option>
            <option value="Personal">Personal</option>
            <option value="Shopping">Shopping</option>
          </select>
        </div>
        <ul id="taskList" class="list-group mt-3" role="list"></ul>
      </div>
    </main>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="script.js"></script>
    <script>
      const taskForm = document.getElementById("taskForm");
      const taskList = document.getElementById("taskList");
      const filterCategory = document.getElementById("filterCategory");
      let tasks = [];

      try {
        tasks = JSON.parse(localStorage.getItem("tasks")) || [];
      } catch (e) {
        console.error("localStorage error:", e);
      }

      function renderTasks() {
        const filter = filterCategory.value;
        taskList.innerHTML = "";
        tasks
          .filter((task) => !filter || task.category === filter)
          .forEach((task, index) => {
            const li = document.createElement("li");
            li.className =
              "list-group-item d-flex justify-content-between align-items-center";
            li.setAttribute("role", "listitem");
            li.innerHTML = `${task.text} <span class="badge bg-primary">${task.category}</span>`;
            const toggleBtn = document.createElement("button");
            toggleBtn.className = "btn btn-secondary btn-sm me-2";
            toggleBtn.textContent = task.completed ? "Undo" : "Complete";
            toggleBtn.setAttribute(
              "aria-label",
              task.completed
                ? `Undo task ${task.text}`
                : `Complete task ${task.text}`
            );
            toggleBtn.onclick = () => {
              tasks[index].completed = !tasks[index].completed;
              saveTasks();
              renderTasks();
            };
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-danger btn-sm";
            deleteBtn.textContent = "Delete";
            deleteBtn.setAttribute("aria-label", `Delete task ${task.text}`);
            deleteBtn.onclick = () => {
              tasks.splice(index, 1);
              saveTasks();
              renderTasks();
            };
            li.append(toggleBtn, deleteBtn);
            if (task.completed) li.style.textDecoration = "line-through";
            taskList.appendChild(li);
          });
      }

      function saveTasks() {
        try {
          localStorage.setItem("tasks", JSON.stringify(tasks));
        } catch (e) {
          console.error("localStorage save error:", e);
        }
      }

      taskForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = document.getElementById("task");
        const category = document.getElementById("category");
        text.classList.toggle("is-invalid", !text.value);
        category.classList.toggle("is-invalid", !category.value);
        if (text.value && category.value) {
          tasks.push({
            text: text.value,
            category: category.value,
            completed: false,
          });
          saveTasks();
          renderTasks();
          taskForm.reset();
        }
      });

      filterCategory.addEventListener("change", renderTasks);

      renderTasks();
    </script>
    <script type="text/javascript">
      var gk_isXlsx = false;
      var gk_xlsxFileLookup = {};
      var gk_fileData = {};
      function filledCell(cell) {
        return cell !== "" && cell != null;
      }
      function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
          try {
            var workbook = XLSX.read(gk_fileData[filename], { type: "base64" });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];

            // Convert sheet to JSON to filter blank rows
            var jsonData = XLSX.utils.sheet_to_json(worksheet, {
              header: 1,
              blankrows: false,
              defval: "",
            });
            // Filter out blank rows (rows where all cells are empty, null, or undefined)
            var filteredData = jsonData.filter((row) => row.some(filledCell));

            // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
            var headerRowIndex = filteredData.findIndex(
              (row, index) =>
                row.filter(filledCell).length >=
                filteredData[index + 1]?.filter(filledCell).length
            );
            // Fallback
            if (headerRowIndex === -1 || headerRowIndex > 25) {
              headerRowIndex = 0;
            }

            // Convert filtered JSON back to CSV
            var csv = XLSX.utils.aoa_to_sheet(
              filteredData.slice(headerRowIndex)
            ); // Create a new sheet from filtered array of arrays
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
          } catch (e) {
            console.error(e);
            return "";
          }
        }
        return gk_fileData[filename] || "";
      }
    </script>
  </body>
</html>
